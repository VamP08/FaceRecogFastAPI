<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Debug — Smooth Face Recognition</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<style>
  body { background:#f0f2f5; }
  .aspect-ratio-wrapper { position:relative; width:100%; padding-top:56.25%; background:#333; border-radius:12px; overflow:hidden; }
  #video-container { position:absolute; inset:0; width:100%; height:100%; }
  #video-feed { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; transform:scaleX(-1); z-index:1; }

  /* Attendance output style (below the video) */
  #attendanceOutput .attendance-card {
    display: flex;
    gap: 14px;
    align-items: center;
    padding: 16px;
    border-radius: 12px;
    border: 2px solid #32a852;
    background: #eafaf0;
    color: #0b5f2e;
    box-shadow: none;
    font-family: "Arial", sans-serif;
  }
  #attendanceOutput .check {
    min-width: 48px;
    min-height: 48px;
    border-radius: 50%;
    background: #2fb86b;
    display:flex;
    align-items:center;
    justify-content:center;
    color:#fff;
    font-weight:700;
    font-size:20px;
  }
  #attendanceOutput .info .name {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 2px;
  }
  #attendanceOutput .info .sub {
    font-size: 13px;
    color: #2a6a3f;
  }

  #canvas-overlay { display:none; } /* hidden overlay */
  #debugPane { margin-top:12px; font-size:14px; }
  #debugJson { white-space:pre-wrap; max-height:160px; overflow:auto; background:#fff; padding:8px; border-radius:6px; border:1px solid #ddd; }
</style>
</head>
<body class="bg-light">
<div class="container my-5">
  <div class="text-center mb-4">
    <h2>Debug Face Recognition Pipeline</h2>
    <p class="text-muted">This page displays diagnostics for capture → encode → upload → response.</p>
  </div>

  <div class="card p-3 shadow-sm">
    <div class="aspect-ratio-wrapper">
      <div id="video-container">
        <video id="video-feed" autoplay muted playsinline></video>
        <canvas id="canvas-overlay"></canvas>
      </div>
    </div>

    <!-- Attendance card appears here -->
    <div id="attendanceOutput" class="mt-3"></div>

    <div class="d-flex gap-2 mt-3">
      <button id="startButton" class="btn btn-primary">Start Camera</button>
      <button id="testCurlBtn" class="btn btn-outline-secondary">Test Server (curl)</button>
    </div>

    <div id="status" class="text-center mt-3"></div>

    <div id="debugPane" class="mt-3">
      <div class="row">
        <div class="col-md-4">
          <ul>
            <li>Target size: <b id="targetSize">640x360</b></li>
            <li>Target FPS: <b id="targetFps">12</b></li>
            <li>Inflight: <b id="inflight">false</b></li>
            <li>Requests sent: <b id="reqSent">0</b></li>
            <li>Requests successful: <b id="reqOk">0</b></li>
            <li>Last response time (ms): <b id="lastRespTime">-</b></li>
            <li>Last faces count: <b id="lastFaceCount">0</b></li>
          </ul>
        </div>
        <div class="col-md-8">
          <div><b>Last response JSON:</b></div>
          <div id="debugJson">— no response yet —</div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
/* ---------------- CONFIG ---------------- */
const TARGET_WIDTH = 640;
const TARGET_HEIGHT = 360;
const TARGET_FPS = 12;
const JPEG_QUALITY = 0.75;
const API_URL = "http://127.0.0.1:8000/recognize";

/* ---------------- DOM ---------------- */
const video = document.getElementById('video-feed');
const overlay = document.getElementById('canvas-overlay');
const startButton = document.getElementById('startButton');
const statusDiv = document.getElementById('status');

const elTargetSize = document.getElementById('targetSize');
const elTargetFps = document.getElementById('targetFps');
const elInflight = document.getElementById('inflight');
const elReqSent = document.getElementById('reqSent');
const elReqOk = document.getElementById('reqOk');
const elLastRespTime = document.getElementById('lastRespTime');
const elLastFaceCount = document.getElementById('lastFaceCount');
const elDebugJson = document.getElementById('debugJson');

elTargetSize.textContent = `${TARGET_WIDTH}x${TARGET_HEIGHT}`;
elTargetFps.textContent = TARGET_FPS;

/* ---------------- state ---------------- */
let worker;
let inflight = false;
let lastCaptureTime = 0;
let reqSent = 0, reqOk = 0;
let running = false;

/* ---------------- attendance output ---------------- */
let attendanceTimeout = null;
function escapeHtml(s) {
  if (!s && s !== 0) return '';
  return String(s)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}
function showAttendanceBelow(name, opts = {}) {
  const when = new Date();
  const hh = String(when.getHours()).padStart(2, '0');
  const mm = String(when.getMinutes()).padStart(2, '0');
  const timeText = opts.timeText || `Marked Attendance at ${hh}:${mm}`;

  const container = document.getElementById('attendanceOutput');
  container.innerHTML = `
    <div class="attendance-card">
      <div class="check">✓</div>
      <div class="info">
         <div class="name">${escapeHtml(name)}</div>
         <div class="sub">${escapeHtml(timeText)}</div>
      </div>
    </div>
  `;
  if (attendanceTimeout) clearTimeout(attendanceTimeout);
  attendanceTimeout = setTimeout(() => { container.innerHTML = ''; }, opts.duration || 8000);
}

/* ---------------- worker creation ---------------- */
function createEncoderWorker() {
  const workerCode = `
    self.onmessage = async (ev) => {
      try {
        const bitmap = ev.data.bitmap;
        const meta = ev.data.meta || {};
        const width = meta.width || bitmap.width;
        const height = meta.height || bitmap.height;
        const quality = meta.quality || 0.8;

        const off = new OffscreenCanvas(width, height);
        const ctx = off.getContext('2d');
        ctx.drawImage(bitmap, 0, 0, width, height);
        bitmap.close();

        const blob = await off.convertToBlob({type: 'image/jpeg', quality: quality});
        self.postMessage({ blob });
      } catch (err) {
        self.postMessage({ error: (err && err.message) || String(err) });
      }
    };
  `;
  const blob = new Blob([workerCode], { type: 'application/javascript' });
  return new Worker(URL.createObjectURL(blob));
}

/* ---------------- start camera ---------------- */
async function startCamera() {
  try {
    statusDiv.innerHTML = '<div class="alert alert-info">Starting camera…</div>';
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { width: TARGET_WIDTH, height: TARGET_HEIGHT, frameRate: { ideal: TARGET_FPS } },
      audio: false
    });
    video.srcObject = stream;
    await video.play();
    statusDiv.innerHTML = '<div class="alert alert-success">Camera started.</div>';
    startButton.style.display = 'none';

    overlay.width = TARGET_WIDTH;
    overlay.height = TARGET_HEIGHT;

    worker = createEncoderWorker();
    worker.onmessage = onWorkerMessage;
    worker.onerror = (e) => console.error('Worker error', e);

    running = true;
    requestAnimationFrame(loopRAF);
  } catch (err) {
    console.error('camera start failed', err);
    statusDiv.innerHTML = `<div class="alert alert-danger">Camera error: ${err.message || err}</div>`;
  }
}

/* ---------------- main capture loop ---------------- */
function loopRAF(ts) {
  if (!running) return;
  const interval = 1000 / TARGET_FPS;
  if (ts - lastCaptureTime >= interval) {
    lastCaptureTime = ts;
    captureFrame();
  }
  requestAnimationFrame(loopRAF);
}
async function captureFrame() {
  if (inflight) return;
  try {
    const bitmap = await createImageBitmap(video, { resizeWidth: TARGET_WIDTH, resizeHeight: TARGET_HEIGHT });
    inflight = true; updateInflightUI();
    worker.postMessage({ bitmap, meta: { width: TARGET_WIDTH, height: TARGET_HEIGHT, quality: JPEG_QUALITY } }, [bitmap]);
  } catch (err) {
    console.error('createImageBitmap failed', err);
    inflight = false; updateInflightUI();
  }
}

/* ---------------- worker → main ---------------- */
async function onWorkerMessage(ev) {
  if (ev.data && ev.data.error) {
    console.error('Worker encoding error:', ev.data.error);
    inflight = false; updateInflightUI();
    return;
  }
  const blob = ev.data && ev.data.blob;
  if (!blob) { inflight = false; updateInflightUI(); return; }

  reqSent++; elReqSent.textContent = reqSent;
  const fd = new FormData(); fd.append('file', blob, 'frame.jpg');

  const start = performance.now();
  let res;
  try {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 12000);
    res = await fetch(API_URL, { method: 'POST', body: fd, signal: controller.signal });
    clearTimeout(timeout);
  } catch (err) {
    console.error('Upload failed:', err);
    inflight = false; updateInflightUI();
    return;
  }

  const elapsed = performance.now() - start;
  elLastRespTime.textContent = Math.round(elapsed);

  if (!res.ok) {
    console.error('Server returned non-OK', res.status, await res.text());
    inflight = false; updateInflightUI();
    return;
  }

  let json;
  try { json = await res.json(); }
  catch (err) {
    console.error('Failed to parse JSON response', err);
    inflight = false; updateInflightUI();
    return;
  }

  // update debug JSON
  elDebugJson.textContent = JSON.stringify(json, null, 2);
  reqOk++; elReqOk.textContent = reqOk;

  // handle recognition
  if (json && json.CODE === 1 && json.DATA && json.DATA.name) {
    showAttendanceBelow(json.DATA.name);
  } else if (json.faces && json.faces.length) {
    const best = json.faces.reduce((acc, f) => {
      const score = (typeof f.score !== 'undefined') ? Number(f.score) : -Infinity;
      if ((f.name && f.name.toLowerCase() !== 'unknown') && score > acc.score) {
        return { name: f.name, score };
      }
      return acc;
    }, {name: null, score: -Infinity});
    if (best.name) showAttendanceBelow(best.name);
  }

  inflight = false; updateInflightUI();
}

/* ---------------- UI helpers ---------------- */
function updateInflightUI() {
  elInflight.textContent = inflight ? 'true' : 'false';
}

/* ---------------- test server ---------------- */
document.getElementById('testCurlBtn').addEventListener('click', async () => {
  const sampleCmd = `curl -X POST -F "file=@test.jpg" ${API_URL}`;
  alert('Run this in your terminal where you have test.jpg:\n\n' + sampleCmd);
});

/* ---------------- wire up start ---------------- */
startButton.addEventListener('click', startCamera);
</script>
</body>
</html>
